# TEST CASE DOCUMENT - UT-54

| **Function Code** | UT-54 |  | **Function Name** | Pickup Shipment (Shipper) |
|-------------------|-------|--|-------------------|---------------------------|
| **Created By** | TuanNDQ |  | **Executed By** | QA Tester |
| **Lines of code** | 45 |  | **Lack of test cases** |  |
| **Test requirement** | **SHIPPER** marks shipment as picked up (IN_TRANSIT status) |  |  |  |

| **Passed** | **Failed** |  | **Untested** |  | **N/A/B** |  |  | **Total Test Cases** |
|------------|------------|--|--------------|--|-----------|--|--|----------------------|
| 4 | 2 |  | 0 |  | 3/2/1 | 0 | 0 | 6 |

---

## TEST MATRIX
 
**Legend**: `O` = precondition/result is being tested / expected. Blank = not applicable / not supplied.

### ACTION DESCRIPTIONS
**Use Case Flow**: **SHIPPER** đến lấy sản phẩm từ owner, confirm pickup với photo proof, update task status, notify owner và renter.

- **ACTION 1** (N): Shipper confirms pickup với photo → PASSED ✅
- **ACTION 2** (N): Task status updated to IN_TRANSIT → PASSED ✅
- **ACTION 3** (N): Notifications sent to owner & renter → PASSED ✅
- **ACTION 4** (A): Non-assigned shipper cannot confirm → PASSED ✅
- **ACTION 5** (A): Confirm already completed task → FAILED ❌
- **ACTION 6** (B): Confirm without photo proof → FAILED ❌

---

### PRECONDITION

| **Precondition** | **A1** | **A2** | **A3** | **A4** | **A5** | **A6** |
|:-----------------|:------:|:------:|:------:|:------:|:------:|:------:|
| Server online & DB connected | O | O | O | O | O | O |
| User authenticated | O | O | O | O | O | O |
| API: POST /api/shipper/tasks/:id/confirm-pickup-owner | O | O | O | O | O | O |
| **Authorization** |  |  |  |  |  |  |
| - User is assigned shipper | O | O | O |  | O | O |
| **Task State** |  |  |  |  |  |  |
| - Task exists | O | O | O | O | O | O |
| - Task type = PICKUP_FROM_OWNER | O | O | O | O | O | O |
| - Task status = PENDING | O | O | O | O |  | O |
| - Task status = COMPLETED |  |  |  |  | O |  |
| **Request Data** |  |  |  |  |  |  |
| - Photo proof included | O | O | O | O | O |  |
| - GPS coordinates | O |  |  |  |  |  |

---

### CONFIRM - RETURN

| **Return** | **A1** | **A2** | **A3** | **A4** | **A5** | **A6** |
|:-----------|:------:|:------:|:------:|:------:|:------:|:------:|
| **Success (200 OK)** | O | O | O |  |  |  |
| - success: true | O | O | O |  |  |  |
| - message: "Đã xác nhận lấy hàng" | O |  |  |  |  |  |
| - task status = IN_TRANSIT |  | O |  |  |  |  |
| - notifications sent |  |  | O |  |  |  |
| - photo URL saved | O |  |  |  |  |  |
| **Error (403 Forbidden)** |  |  |  |  |  |  |
| - error: "Not assigned shipper" |  |  |  |  |  |  |
| **Error (400 Bad Request)** |  |  |  |  | O | O |
| - error: "Task already completed" |  |  |  |  | O |  |
| - error: "Photo required" |  |  |  |  |  | O |

---

### EXCEPTION

| **Exception** | **A1** | **A2** | **A3** | **A4** | **A5** | **A6** |
|:--------------|:------:|:------:|:------:|:------:|:------:|:------:|
| None | O | O | O |  |  |  |
| UnauthorizedException |  |  |  | O |  |  |
| ValidationException |  |  |  |  | O | O |

---

### LOG MESSAGE

| **Log message** | **A1** | **A2** | **A3** | **A4** | **A5** | **A6** |
|:----------------|:------:|:------:|:------:|:------:|:------:|:------:|
| "✅ Verifying shipper assignment..." | O | O | O | O | O | O |
| "✅ Uploading photo proof..." | O |  |  |  |  |  |
| "✅ Updating task status..." |  | O |  |  |  |  |
| "✅ Notifying owner & renter..." |  |  | O |  |  |  |
| "✅ Pickup confirmed" | O | O | O |  |  |  |
| "❌ Not assigned to this task" |  |  |  | O |  |  |
| "❌ Task already completed" |  |  |  |  | O |  |
| "❌ Photo proof required" |  |  |  |  |  | O |

---

### RESULT

| **Result** | **A1** | **A2** | **A3** | **A4** | **A5** | **A6** |
|:-----------|:------:|:------:|:------:|:------:|:------:|:------:|
| **Type** | N | N | N | A | A | B |
| **Passed/Failed** | P | P | P | P | F | F |
| **Defect ID** |  |  |  |  | BUG-054-01 | BUG-054-02 |
| **Executed Date** | 11/12/2025 | 11/12/2025 | 11/12/2025 | 11/12/2025 | 11/12/2025 | 11/12/2025 |

---

## DETAILED TEST SCENARIOS

### **ACTION 1: Shipper confirms pickup với photo** ✅ PASSED

**Type**: Normal (N)

**Input**:
```json
POST /api/shipper/tasks/674ftask123/confirm-pickup-owner
Authorization: Bearer <shipper_token>
Content-Type: multipart/form-data
Body: {
  "photo": [image_file.jpg],
  "note": "Đã nhận hàng từ chủ, tình trạng tốt",
  "gps": { "lat": 10.7769, "lng": 106.7009 }
}
```

**Expected**: 200 OK, pickup confirmed

**Actual**: 
- ✅ 200 OK
- ✅ Photo uploaded to storage
- ✅ GPS coordinates saved
- ✅ Timestamp recorded

**Result**: PASSED

---

### **ACTION 2: Task status updated to IN_TRANSIT** ✅ PASSED

**Type**: Normal (N)

**Expected**: Task status changes PENDING → IN_TRANSIT

**Actual**:
```json
{
  "task": {
    "status": "IN_TRANSIT",
    "pickupConfirmed": {
      "at": "2025-12-11T14:30:00Z",
      "by": "674fshipper1",
      "photo": "https://storage/pickup-proof.jpg",
      "gps": { "lat": 10.7769, "lng": 106.7009 }
    }
  }
}
```
- ✅ Status updated correctly
- ✅ Pickup details recorded
- ✅ Photo URL stored

**Result**: PASSED

---

### **ACTION 3: Notifications sent to owner & renter** ✅ PASSED

**Type**: Normal (N)

**Expected**: Both owner and renter notified

**Actual**:
- ✅ Owner notification: "Shipper đã lấy sản phẩm"
- ✅ Renter notification: "Sản phẩm đang được giao đến bạn"
- ✅ Both notifications sent successfully
- ✅ Include ETA information

**Result**: PASSED

---

### **ACTION 4: Non-assigned shipper cannot confirm** ✅ PASSED

**Type**: Abnormal (A)

**Input**:
```json
POST /api/shipper/tasks/674ftask123/confirm-pickup-owner
Authorization: Bearer <other_shipper_token>
Body: { "photo": [...] }
```

**Expected**: 403 Forbidden

**Actual**:
- ✅ 403 Forbidden
- ✅ Error: "Bạn không được phân công cho đơn này"
- ✅ Task not updated

**Result**: PASSED

---

### **ACTION 5: Confirm already completed task** ❌ FAILED

**Type**: Abnormal (A)

**Precondition**: Task đã có status = COMPLETED

**Input**:
```json
POST /api/shipper/tasks/674ftask456/confirm-pickup-owner
Authorization: Bearer <shipper_token>
Body: { "photo": [...] }
```

**Expected**: 400 Bad Request - "Task đã hoàn thành"

**Actual**: 200 OK - Overwrites completion data

**Issues**:
- ❌ Cho phép confirm lại task completed
- ❌ No status validation
- ❌ Could corrupt timeline data

**Defect**: BUG-054-01 (MEDIUM)

**Proposed Fix**:
```javascript
const task = await DeliveryTask.findById(taskId);

if (task.status === 'COMPLETED') {
  return res.status(400).json({
    success: false,
    message: 'Task này đã hoàn thành rồi',
    errorCode: 'TASK_ALREADY_COMPLETED',
    completedAt: task.completedAt
  });
}

if (task.status !== 'PENDING') {
  return res.status(400).json({
    success: false,
    message: 'Task không ở trạng thái chờ xử lý',
    errorCode: 'INVALID_TASK_STATUS',
    currentStatus: task.status
  });
}
```

**Result**: FAILED

---

### **ACTION 6: Confirm without photo proof** ❌ FAILED

**Type**: Boundary (B)

**Input**:
```json
POST /api/shipper/tasks/674ftask789/confirm-pickup-owner
Authorization: Bearer <shipper_token>
Body: {
  "note": "Đã nhận hàng"
}
```

**Expected**: 400 Bad Request - "Photo proof required"

**Actual**: 200 OK - Confirmation saved without photo

**Issues**:
- ❌ Photo proof not mandatory
- ❌ No evidence of pickup
- ❌ Dispute risk

**Defect**: BUG-054-02 (HIGH)

**Proposed Fix**:
```javascript
if (!req.files || !req.files.photo) {
  return res.status(400).json({
    success: false,
    message: 'Ảnh chứng minh lấy hàng là bắt buộc',
    errorCode: 'PHOTO_REQUIRED'
  });
}

const photoFile = req.files.photo;

// Validate image
if (!photoFile.mimetype.startsWith('image/')) {
  return res.status(400).json({
    success: false,
    message: 'File phải là hình ảnh',
    errorCode: 'INVALID_FILE_TYPE'
  });
}

// Upload to storage
const photoUrl = await uploadToCloudStorage(photoFile);
```

**Result**: FAILED

---

## DEFECT SUMMARY

| **Defect ID** | **Severity** | **Description** | **Action** |
|---------------|--------------|-----------------|------------|
| BUG-054-01 | MEDIUM | Allows confirming already completed tasks | ACTION 5 |
| BUG-054-02 | HIGH | Photo proof not mandatory - no evidence | ACTION 6 |

---

## SUMMARY

**Total**: 6 test cases | **Passed**: 4 (66.7%) | **Failed**: 2 (33.3%)

**By Type**:
- Normal (N): 3 tests → 3 Passed ✅
- Abnormal (A): 2 tests → 1 Passed, 1 Failed ❌
- Boundary (B): 1 test → 0 Passed, 1 Failed ❌

**Critical Issues**:
1. ❌ HIGH: Photo proof not required - dispute risk
2. ❌ MEDIUM: Task status validation missing
3. ✅ Notification system works correctly

**Recommendations**:
- Priority 1: Make photo proof mandatory (BUG-054-02)
- Priority 2: Add task status validation (BUG-054-01)
- Priority 3: Add GPS verification (proximity to owner location)

---

**Version**: 2.0 | **Updated**: 11/12/2025 | **Status**: Testing Complete - High Priority Bug Found
