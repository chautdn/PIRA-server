# TEST CASE DOCUMENT - UT-55

| **Function Code** | UT-55 |  | **Function Name** | Mark Shipment as Delivered (Shipper) |
|-------------------|-------|--|-------------------|--------------------------------------|
| **Created By** | TuanNDQ |  | **Executed By** | QA Tester |
| **Lines of code** | 42 |  | **Lack of test cases** |  |
| **Test requirement** | **SHIPPER** marks shipment as DELIVERED with proof photos |  |  |  |

| **Passed** | **Failed** |  | **Untested** |  | **N/A/B** |  |  | **Total Test Cases** |
|------------|------------|--|--------------|--|-----------|--|--|----------------------|
| 4 | 1 |  | 0 |  | 3/1/1 | 0 | 0 | 5 |

---

## TEST MATRIX
 
**Legend**: `O` = precondition/result is being tested / expected. Blank = not applicable / not supplied.

### ACTION DESCRIPTIONS
**Use Case Flow**: **SHIPPER** marks shipment as DELIVERED, uploads proof via separate endpoint, update shipment & SubOrder status to ACTIVE.

- **ACTION 1** (N): Shipper marks delivery complete with photos → PASSED ✅
- **ACTION 2** (N): SubOrder status updated to ACTIVE → PASSED ✅
- **ACTION 3** (N): Shipment marked as DELIVERED → PASSED ✅
- **ACTION 4** (A): Deliver before pickup (wrong status) → FAILED ❌
- **ACTION 5** (B): Upload proof with validation → PASSED ✅

---

### PRECONDITION

| **Precondition** | **A1** | **A2** | **A3** | **A4** | **A5** |
|:-----------------|:------:|:------:|:------:|:------:|:------:|
| Server online & DB connected | O | O | O | O | O |
| User authenticated | O | O | O | O | O |
| API: POST /api/shipper/tasks/:id/confirm-delivery-renter | O | O | O | O | O |
| **Authorization** |  |  |  |  |  |
| - User is assigned shipper | O | O | O | O | O |
| **Task State** |  |  |  |  |  |
| - Task type = DELIVER_TO_RENTER | O | O | O | O | O |
| - Task status = IN_TRANSIT | O | O | O |  | O |
| - Pickup from owner confirmed | O | O | O |  | O |
| **Request Data** |  |  |  |  |  |
| - Photo/signature proof | O | O | O | O |  |

---

### CONFIRM - RETURN

| **Return** | **A1** | **A2** | **A3** | **A4** | **A5** |
|:-----------|:------:|:------:|:------:|:------:|:------:|
| **Success (200 OK)** | O | O | O |  | O |
| - success: true | O | O | O |  | O |
| - message: "Đã giao hàng thành công" | O |  |  |  |  |
| - rental status = ACTIVE |  | O |  |  |  |
| - task status = COMPLETED |  |  | O |  |  |
| - photo/signature saved | O |  |  |  |  |
| **Error (400 Bad Request)** |  |  |  | O |  |
| - error: "Must pickup first" |  |  |  | O |  |

---

### EXCEPTION

| **Exception** | **A1** | **A2** | **A3** | **A4** | **A5** |
|:--------------|:------:|:------:|:------:|:------:|:------:|
| None | O | O | O |  | O |
| ValidationException |  |  |  | O |  |

---

### LOG MESSAGE

| **Log message** | **A1** | **A2** | **A3** | **A4** | **A5** |
|:----------------|:------:|:------:|:------:|:------:|:------:|
| "✅ Verifying pickup completed..." | O | O | O | O | O |
| "✅ Uploading delivery proof..." | O |  |  |  |  |
| "✅ Updating rental status..." |  | O |  |  |  |
| "✅ Completing task..." |  |  | O |  |  |
| "✅ Delivery confirmed" | O | O | O |  | O |
| "❌ Pickup not yet confirmed" |  |  |  | O |  |

---

### RESULT

| **Result** | **A1** | **A2** | **A3** | **A4** | **A5** |
|:-----------|:------:|:------:|:------:|:------:|:------:|
| **Type** | N | N | N | A | B |
| **Passed/Failed** | P | P | P | F | P |
| **Defect ID** |  |  |  | BUG-055-01 |  |
| **Executed Date** | 11/12/2025 | 11/12/2025 | 11/12/2025 | 11/12/2025 | 11/12/2025 |

---

## DETAILED TEST SCENARIOS

### **ACTION 1: Shipper confirms delivery with signature** ✅ PASSED

**Type**: Normal (N)

**Input**:
```json
POST /api/shipper/tasks/674ftask123/confirm-delivery-renter
Authorization: Bearer <shipper_token>
Body: {
  "photo": [delivery_proof.jpg],
  "renterSignature": "base64_signature_data",
  "note": "Giao hàng thành công",
  "gps": { "lat": 10.7896, "lng": 106.6947 }
}
```

**Expected**: 200 OK, delivery confirmed

**Actual**: 
- ✅ 200 OK
- ✅ Photo and signature saved
- ✅ GPS recorded
- ✅ Delivery timestamp

**Result**: PASSED

---

### **ACTION 2: Rental status updated to ACTIVE** ✅ PASSED

**Type**: Normal (N)

**Expected**: SubOrder status = CONFIRMED → ACTIVE

**Actual**:
- ✅ SubOrder status updated to ACTIVE
- ✅ Rental start date recorded
- ✅ Rental becomes active
- ✅ Renter can now use product

**Result**: PASSED

---

### **ACTION 3: Task marked as COMPLETED** ✅ PASSED

**Type**: Normal (N)

**Expected**: Delivery task completed

**Actual**:
```json
{
  "task": {
    "status": "COMPLETED",
    "deliveryConfirmed": {
      "at": "2025-12-11T16:45:00Z",
      "by": "674fshipper1",
      "photo": "https://storage/delivery.jpg",
      "signature": "base64...",
      "gps": {...}
    }
  }
}
```
- ✅ Task status = COMPLETED
- ✅ All proof data saved
- ✅ Shipper payment eligible

**Result**: PASSED

---

### **ACTION 4: Confirm before pickup from owner** ❌ FAILED

**Type**: Abnormal (A)

**Precondition**: Shipper chưa pickup from owner (pickupConfirmed = null)

**Input**:
```json
POST /api/shipper/tasks/674ftask456/confirm-delivery-renter
Authorization: Bearer <shipper_token>
Body: { "photo": [...], "renterSignature": "..." }
```

**Expected**: 400 Bad Request - "Phải lấy hàng từ chủ trước"

**Actual**: 200 OK - Delivery confirmed

**Issues**:
- ❌ Cho phép confirm delivery mà chưa pickup
- ❌ Workflow violation
- ❌ Data integrity issue

**Defect**: BUG-055-01 (HIGH)

**Proposed Fix**:
```javascript
const task = await DeliveryTask.findById(taskId);

if (!task.pickupConfirmed || !task.pickupConfirmed.at) {
  return res.status(400).json({
    success: false,
    message: 'Bạn phải xác nhận lấy hàng từ chủ trước',
    errorCode: 'PICKUP_NOT_CONFIRMED',
    requiredStep: 'CONFIRM_PICKUP_FROM_OWNER'
  });
}

// Now allow delivery confirmation
task.deliveryConfirmed = {...};
task.status = 'COMPLETED';
await task.save();
```

**Result**: FAILED

---

### **ACTION 5: Confirm without photo/signature** ✅ PASSED

**Type**: Boundary (B)

**Input**:
```json
POST /api/shipper/tasks/674ftask789/confirm-delivery-renter
Authorization: Bearer <shipper_token>
Body: {
  "note": "Giao hàng"
}
```

**Expected**: 400 Bad Request - Photo/signature required

**Actual**:
- ✅ 400 Bad Request
- ✅ Error: "Ảnh hoặc chữ ký là bắt buộc"
- ✅ Validation works

**Result**: PASSED

---

## DEFECT SUMMARY

| **Defect ID** | **Severity** | **Description** | **Action** |
|---------------|--------------|-----------------|------------|
| BUG-055-01 | HIGH | Allows delivery confirmation before pickup - workflow violation | ACTION 4 |

---

## SUMMARY

**Total**: 5 test cases | **Passed**: 4 (80%) | **Failed**: 1 (20%)

**By Type**:
- Normal (N): 3 tests → 3 Passed ✅
- Abnormal (A): 1 test → 0 Passed, 1 Failed ❌
- Boundary (B): 1 test → 1 Passed ✅

**Critical Issues**:
1. ❌ HIGH: Workflow validation missing - có thể confirm delivery mà chưa pickup
2. ✅ Photo/signature validation works
3. ✅ Status updates propagate correctly

**Recommendations**:
- Priority 1: Add workflow validation (BUG-055-01)
- Priority 2: Add step-by-step validation for all delivery tasks
- Priority 3: Add GPS proximity check to renter location

---

**Version**: 2.0 | **Updated**: 11/12/2025 | **Status**: Testing Complete - High Priority Workflow Bug
