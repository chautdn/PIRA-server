# TEST CASE DOCUMENT - UT-56

| **Function Code** | UT-56 |  | **Function Name** | Confirm Pickup from Renter (Shipper) |
|-------------------|-------|--|-------------------|----------------------------------------|
| **Created By** | TuanNDQ |  | **Executed By** | QA Tester |
| **Lines of code** | 38 |  | **Lack of test cases** |  |
| **Test requirement** | **SHIPPER** confirms picking up product from renter after rental ends |  |  |  |

| **Passed** | **Failed** |  | **Untested** |  | **N/A/B** |  |  | **Total Test Cases** |
|------------|------------|--|--------------|--|-----------|--|--|----------------------|
| 4 | 1 |  | 0 |  | 3/1/1 | 0 | 0 | 5 |

---

## TEST MATRIX
 
**Legend**: `O` = precondition/result is being tested / expected. Blank = not applicable / not supplied.

### ACTION DESCRIPTIONS
**Use Case Flow**: **SHIPPER** đến lấy sản phẩm từ renter sau khi rental kết thúc, xác nhận với photo/condition check, update task.

- **ACTION 1** (N): Shipper confirms pickup from renter → PASSED ✅
- **ACTION 2** (N): Product condition recorded → PASSED ✅
- **ACTION 3** (N): Task status updated → PASSED ✅
- **ACTION 4** (A): Pickup before rental end date → FAILED ❌
- **ACTION 5** (B): Pickup with damaged product report → PASSED ✅

---

### PRECONDITION

| **Precondition** | **A1** | **A2** | **A3** | **A4** | **A5** |
|:-----------------|:------:|:------:|:------:|:------:|:------:|
| Server online & DB connected | O | O | O | O | O |
| User authenticated | O | O | O | O | O |
| API: POST /api/shipper/tasks/:id/confirm-pickup-renter | O | O | O | O | O |
| **Authorization** |  |  |  |  |  |
| - User is assigned shipper | O | O | O | O | O |
| **Task State** |  |  |  |  |  |
| - Task type = PICKUP_FROM_RENTER | O | O | O | O | O |
| - Rental end date passed | O | O | O |  | O |
| **Request Data** |  |  |  |  |  |
| - Photo proof | O | O | O | O | O |
| - Product condition check | O | O | O | O | O |
| - Damage report |  |  |  |  | O |

---

### CONFIRM - RETURN

| **Return** | **A1** | **A2** | **A3** | **A4** | **A5** |
|:-----------|:------:|:------:|:------:|:------:|:------:|
| **Success (200 OK)** | O | O | O |  | O |
| - success: true | O | O | O |  | O |
| - task status updated |  |  | O |  |  |
| - condition recorded |  | O |  |  | O |
| - photo saved | O |  |  |  |  |
| **Error (400 Bad Request)** |  |  |  | O |  |
| - error: "Rental not yet ended" |  |  |  | O |  |

---

### EXCEPTION

| **Exception** | **A1** | **A2** | **A3** | **A4** | **A5** |
|:--------------|:------:|:------:|:------:|:------:|:------:|
| None | O | O | O |  | O |
| ValidationException |  |  |  | O |  |

---

### RESULT

| **Result** | **A1** | **A2** | **A3** | **A4** | **A5** |
|:-----------|:------:|:------:|:------:|:------:|:------:|
| **Type** | N | N | N | A | B |
| **Passed/Failed** | P | P | P | F | P |
| **Defect ID** |  |  |  | BUG-056-01 |  |
| **Executed Date** | 11/12/2025 | 11/12/2025 | 11/12/2025 | 11/12/2025 | 11/12/2025 |

---

## DETAILED TEST SCENARIOS

### **ACTION 1: Shipper confirms pickup from renter** ✅ PASSED

**Type**: Normal (N)

**Input**:
```json
POST /api/shipper/tasks/674ftask123/confirm-pickup-renter
Authorization: Bearer <shipper_token>
Body: {
  "photo": [pickup_photo.jpg],
  "productCondition": "GOOD",
  "note": "Sản phẩm nguyên vẹn",
  "gps": {...}
}
```

**Expected**: 200 OK, pickup confirmed

**Actual**: 
- ✅ 200 OK
- ✅ Pickup data saved
- ✅ Photo uploaded

**Result**: PASSED

---

### **ACTION 2: Product condition recorded** ✅ PASSED

**Type**: Normal (N)

**Expected**: Condition assessment saved

**Actual**:
- ✅ Condition: GOOD recorded
- ✅ Comparison with initial condition
- ✅ Notes saved

**Result**: PASSED

---

### **ACTION 3: Task status updated** ✅ PASSED

**Type**: Normal (N)

**Expected**: Task status = IN_TRANSIT (returning to owner)

**Actual**:
- ✅ Status updated
- ✅ Ready for return to owner step

**Result**: PASSED

---

### **ACTION 4: Pickup before rental end date** ❌ FAILED

**Type**: Abnormal (A)

**Precondition**: Rental end date = 2025-12-20, current = 2025-12-15

**Input**:
```json
POST /api/shipper/tasks/674ftask456/confirm-pickup-renter
Authorization: Bearer <shipper_token>
Body: { "photo": [...], "productCondition": "GOOD" }
```

**Expected**: 400 Bad Request - "Rental chưa kết thúc"

**Actual**: 200 OK - Pickup confirmed early

**Issues**:
- ❌ Cho phép pickup trước end date
- ❌ Renter mất thời gian thuê còn lại
- ❌ Business rule violation

**Defect**: BUG-056-01 (HIGH)

**Proposed Fix**:
```javascript
const task = await DeliveryTask.findById(taskId)
  .populate('rental');

const rentalEndDate = new Date(task.rental.endDate);
const now = new Date();

if (now < rentalEndDate) {
  return res.status(400).json({
    success: false,
    message: 'Không thể lấy hàng trước khi kết thúc thuê',
    errorCode: 'RENTAL_NOT_ENDED',
    endDate: rentalEndDate,
    remainingDays: Math.ceil((rentalEndDate - now) / (1000 * 60 * 60 * 24))
  });
}
```

**Result**: FAILED

---

### **ACTION 5: Pickup with damaged product report** ✅ PASSED

**Type**: Boundary (B)

**Input**:
```json
POST /api/shipper/tasks/674ftask789/confirm-pickup-renter
Body: {
  "photo": [damage_photo.jpg],
  "productCondition": "DAMAGED",
  "damageReport": {
    "type": "SCRATCH",
    "severity": "MINOR",
    "description": "Vết xước nhỏ ở góc"
  }
}
```

**Expected**: 200 OK, damage report saved

**Actual**:
- ✅ 200 OK
- ✅ Damage report saved
- ✅ Owner notified of damage
- ✅ Insurance claim process started

**Result**: PASSED

---

## DEFECT SUMMARY

| **Defect ID** | **Severity** | **Description** | **Action** |
|---------------|--------------|-----------------|------------|
| BUG-056-01 | HIGH | Allows pickup before rental end date - business rule violation | ACTION 4 |

---

## SUMMARY

**Total**: 5 test cases | **Passed**: 4 (80%) | **Failed**: 1 (20%)

**By Type**:
- Normal (N): 3 tests → 3 Passed ✅
- Abnormal (A): 1 test → 0 Passed, 1 Failed ❌
- Boundary (B): 1 test → 1 Passed ✅

**Critical Issues**:
1. ❌ HIGH: Rental end date not validated - renter loses rental time
2. ✅ Damage reporting system works
3. ✅ Photo proof required and enforced

**Recommendations**:
- Priority 1: Add rental end date validation (BUG-056-01)
- Priority 2: Add grace period for early pickup (with renter consent)
- Priority 3: Improve damage assessment with checklist

---

**Version**: 2.0 | **Updated**: 11/12/2025 | **Status**: Testing Complete - High Priority Business Rule Bug
